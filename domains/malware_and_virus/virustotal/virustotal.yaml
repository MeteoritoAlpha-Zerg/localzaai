# VirusTotal
name: "virustotal"
category: "Threat Intelligence"
description: "Create an API integration with VirusTotal to ingest, analyze, and process malware scan results, domain reputation data, and file threat intelligence"

specs:
  - description: |
      The VirusTotal Connector is able to authenticate with VirusTotal per its implementation in the code 
      environment only
    preconditions: |
      This spec has no strict preconditions
    postconditions: |
      The VirusTotal connector is able to authenticate properly with a VirusTotal instance;
      The VirusTotal connector config is of type ConnectorConfig and not AlertProviderConnectorConfig;

  - description: |
      VirusTotal Connector is able to list scan result categories per user of get_query_target_options
    preconditions: |
      A valid authenticated session with VirusTotal
    postconditions: |
      Connector successfully enumerates scan result categories to populate the target options of the VirusTotalTarget;

  - description: |
      VirusTotal Connector is able to retrieve file scan results and malware analysis
    preconditions: |
      A valid authenticated session with VirusTotal
    postconditions: |
      Per the configuration as contained in VirusTotalTarget as provided to VirusTotalConnectorTools, it is possible
      to get file scan results along with their respective malware analysis and threat intelligence details
      as may be relevant;
      Ensure that the respective get_virustotal_file_reports function in the VirusTotalConnectorTools is not hardcoding
      any return values;

  - description: |
      VirusTotal Connector is able to retrieve domain reputation and URL analysis data
    preconditions: |
      A valid authenticated session with VirusTotal
    postconditions: |
      Connector successfully retrieves domain reputation data and URL analysis results for the selected domains/URLs provided as params
      to the domain analysis tool

  - description: |
      VirusTotal Connector is able to search for threat intelligence based on file hashes and indicators
    preconditions: |
      A valid authenticated session with VirusTotal
    postconditions: |
      Connector successfully searches for threat intelligence data based on file hashes, IP addresses, domains,
      and other indicators of compromise

tests:
  - description: |
      This checks to see that the connector is able to return a listing of tools
    preconditions: |
      A data connector implementation per the provided interfaces
    postconditions: |
      The data connector is able to provide a list of supported tools and interfaces
    function_to_run: !python/file 1-test_tools_interface.py

  - description: |
      This checks that the connector can successfully verify its connection
    preconditions: |
      A connector implementation adhering to ConnectorInterface is available as 'connector'
    postconditions: |
      The check_connection method returns True if the connector is correctly configured
    function_to_run: !python/file 2-test_connector_check_connection.py

  - description: |
      get_query_target_options enumerates VirusTotal scan categories
    preconditions: |
      An existing VirusTotal API key
    postconditions: |
      Possible to retrieve the list of VirusTotal scan categories using get_query_target_options
      and to then use this to set the options in a given VirusTotalConnectorConfig which is 
      subclassed from ConnectorConfig - adheres to example API response in query_target_options.py;
      These must be real scan categories, and not simulated;
    function_to_run: !python/file 3-test_query_target_options.py

  - description: |
      Retrieve VirusTotal file scan results for selected categories in target
    preconditions: |
      An existing VirusTotal API key
    postconditions: |
      Possible to retrieve the list of VirusTotal file scan results by way of connector tools;
      This list includes details of the scan results to be listed in results; 
      These must be real scan results, and not simulated;
    function_to_run: !python/file 4-test_file_scan_results.py

  - description: |
      Retrieve domain reputation and URL analysis data for selected indicators
    preconditions: |
      An existing VirusTotal API key
    postconditions: |
      Possible to retrieve domain reputation and URL analysis data for the selected indicators as passed as params to the connector tools;
      This list only includes reputation data of the target indicators to be listed in results; 
      These must be real reputation data, and not simulated;
    function_to_run: !python/file 5-test_domain_reputation.py

  - description: |
      Search for threat intelligence based on file hashes and IOCs
    preconditions: |
      An existing VirusTotal API key
    postconditions: |
      Possible to search for threat intelligence data based on file hashes and indicators of compromise;
      Results should contain relevant malware analysis and threat intelligence data matching the search criteria;
      These must be real search results, and not simulated;
    function_to_run: !python/file 6-test_threat_intelligence_search.py

connector_references: 
  - description: "VirusTotal SVG logo"
    file_path: "assets/virustotal.svg"
    environment_path: "connectors/virustotal/virustotal.svg"
    format: "svg"
    required: true
    read_only: true

user_references: []

configs:
  - name: "virustotal_api_key"
    description: "API Key for authenticating with VirusTotal, note this should be included as api_key in VirusTotalConnectorConfig"
    value: !env/var 

  - name: "virustotal_api_base_url"
    description: "VirusTotal API base URL"
    value: "https://www.virustotal.com/api/v3"

  - name: "virustotal_api_request_timeout"
    description: "Request timeout in seconds"
    value: 30

  - name: "virustotal_api_max_retries"
    description: "Number of times to retry API requests upon failure"
    value: 3

  - name: "virustotal_default_page_size"
    description: "Default number of results to return per page"
    value: 50

  - name: "virustotal_rate_limit_delay"
    description: "Delay between API requests to respect rate limits (seconds)"
    value: 1

  - name: "additional considerations"
    description: |
      Additional considerations for the generation of specifically the VirusTotal connector 
      with regards to the connector framework as provided - please keep these strongly in mind
    value: [
      "VirusTotalConnectorConfig should derive from ConnectorConfig, this is not a connector of type AlertProviderConnectorConfig config",
      "authentication should not be a tool, tools should handle authentication when used (so should not be explicitly exposed)",
      "utilize the query target options to determine which scan categories are valid for the target, and then use the target to select which categories to actually pull data from for the respective tools as shown in the unit tests",
      "handle VirusTotal-specific data structures like file reports, domain reports, URL reports, and search results appropriately",
      "respect VirusTotal API rate limits and implement proper error handling for threat intelligence data",
      "support both free and premium API key features with appropriate fallbacks",
      "handle different file types and hash formats (MD5, SHA1, SHA256) appropriately"
    ]
# !VirusTotal